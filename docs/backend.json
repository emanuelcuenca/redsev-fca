{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the VínculoAgro application, with distinct roles determining access and functionality. Authentication details are managed by an external system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user, primarily used as an identifier for authentication (handled externally).",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "Full name of the user."
        },
        "role": {
          "type": "string",
          "description": "The role of the user within the VínculoAgro application. 'Administrator' for the Secretaría (can upload and manage documents), 'Viewer' for all other users (can search, view, and summarize documents).",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user account was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "name",
        "role",
        "createdAt",
        "updatedAt"
      ]
    },
    "Document": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Document",
      "type": "object",
      "description": "Represents a document stored in the VínculoAgro repository, including its associated metadata and file location.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Document entity."
        },
        "title": {
          "type": "string",
          "description": "The official title of the document."
        },
        "description": {
          "type": "string",
          "description": "An optional brief description or abstract of the document's content."
        },
        "fileUrl": {
          "type": "string",
          "description": "The URL or path where the actual document file is stored.",
          "format": "uri"
        },
        "fileType": {
          "type": "string",
          "description": "The type of the document file (e.g., 'PDF', 'DOCX', 'JPG')."
        },
        "uploadDate": {
          "type": "string",
          "description": "The date and time when the document was uploaded to the repository.",
          "format": "date-time"
        },
        "uploadedByUserId": {
          "type": "string",
          "description": "Reference to the User who uploaded this document. (Relationship: User 1:N Document)"
        },
        "agreementTypeId": {
          "type": "string",
          "description": "Reference to the type of agreement or convention this document relates to. (Relationship: AgreementType 1:N Document)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the project this document is associated with. (Relationship: Project 1:N Document)"
        },
        "authorIds": {
          "type": "array",
          "description": "References to the Author entities associated with this document. (Relationship: Author N:N Document)",
          "items": {
            "type": "string"
          }
        },
        "keywordIds": {
          "type": "array",
          "description": "References to Keyword entities manually assigned to this document for search and categorization. (Relationship: Keyword N:N Document)",
          "items": {
            "type": "string"
          }
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "An optional URL to a thumbnail image or preview of the document.",
          "format": "uri"
        },
        "summary": {
          "type": "string",
          "description": "An optional concise summary of the document's content, potentially generated by an AI tool."
        },
        "extractedKeywords": {
          "type": "array",
          "description": "Optional keywords automatically extracted from the document content by an AI tool.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "title",
        "fileUrl",
        "fileType",
        "uploadDate",
        "uploadedByUserId",
        "agreementTypeId",
        "projectId",
        "authorIds"
      ]
    },
    "AgreementType": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AgreementType",
      "type": "object",
      "description": "Defines categories for different types of agreements or conventions that documents may relate to.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AgreementType entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the agreement type (e.g., 'Convenio Marco', 'Proyecto de Investigación')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of this agreement type."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a specific project or initiative that documents are associated with.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the project."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the project."
        },
        "startDate": {
          "type": "string",
          "description": "The start date of the project.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The anticipated or actual end date of the project.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Author": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Author",
      "type": "object",
      "description": "Represents an individual author or contributing entity for a document.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Author entity."
        },
        "name": {
          "type": "string",
          "description": "The full name of the author."
        },
        "email": {
          "type": "string",
          "description": "The email address of the author.",
          "format": "email"
        },
        "institution": {
          "type": "string",
          "description": "The institution or affiliation of the author."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Keyword": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Keyword",
      "type": "object",
      "description": "Represents a searchable keyword or tag used to categorize documents.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Keyword entity."
        },
        "word": {
          "type": "string",
          "description": "The keyword string itself (e.g., 'Investigación', 'Desarrollo Rural')."
        }
      },
      "required": [
        "id",
        "word"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores individual user profiles. Users can read their own profiles, while administrators may have broader read/write access. Includes the 'role' field for application display, but not for primary security rule authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "A dedicated collection to identify administrators for DBAC (Database Access Control). A document exists here if the corresponding userId is an administrator. This is crucial for Authorization Independence, enabling atomic 'exists()' checks in security rules without relying on 'get()' from the /users collection.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the administrator user."
            }
          ]
        }
      },
      {
        "path": "/documents/{documentId}",
        "definition": {
          "entityName": "Document",
          "schema": {
            "$ref": "#/backend/entities/Document"
          },
          "description": "Stores all document records. Documents are viewable (read/list) by any authenticated user. Only authenticated users with an entry in the /roles_admin collection (i.e., administrators) can create, update, or delete documents. The 'uploadedByUserId' field is for audit purposes.",
          "params": [
            {
              "name": "documentId",
              "description": "The unique identifier of the document."
            }
          ]
        }
      },
      {
        "path": "/agreementTypes/{agreementTypeId}",
        "definition": {
          "entityName": "AgreementType",
          "schema": {
            "$ref": "#/backend/entities/AgreementType"
          },
          "description": "Stores metadata for different types of agreements. These are read/listable by all authenticated users and only manageable (create/update/delete) by administrators.",
          "params": [
            {
              "name": "agreementTypeId",
              "description": "The unique identifier of the agreement type."
            }
          ]
        }
      },
      {
        "path": "/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Stores metadata for projects. These are read/listable by all authenticated users and only manageable (create/update/delete) by administrators.",
          "params": [
            {
              "name": "projectId",
              "description": "The unique identifier of the project."
            }
          ]
        }
      },
      {
        "path": "/authors/{authorId}",
        "definition": {
          "entityName": "Author",
          "schema": {
            "$ref": "#/backend/entities/Author"
          },
          "description": "Stores author information. These are read/listable by all authenticated users and only manageable (create/update/delete) by administrators.",
          "params": [
            {
              "name": "authorId",
              "description": "The unique identifier of the author."
            }
          ]
        }
      },
      {
        "path": "/keywords/{keywordId}",
        "definition": {
          "entityName": "Keyword",
          "schema": {
            "$ref": "#/backend/entities/Keyword"
          },
          "description": "Stores searchable keywords. These are read/listable by all authenticated users and only manageable (create/update/delete) by administrators.",
          "params": [
            {
              "name": "keywordId",
              "description": "The unique identifier of the keyword."
            }
          ]
        }
      }
    ],
    "reasoning": "The proposed Firestore structure for VínculoAgro prioritizes security, scalability, and debuggability by adhering to the core design principles. The primary authorization model differentiates between 'Administrators' (Secretaría) who can upload and manage documents and associated metadata, and 'Viewers' (all other authenticated users) who can search, view, and summarize documents. This is achieved through explicit structural segregation and denormalization.\n\n**Authorization Independence (CRITICAL):** This is achieved by creating a dedicated top-level collection, `/roles_admin/{userId}`. Instead of relying on a `get()` operation to fetch a user's `role` field from their `/users/{userId}` profile, security rules can perform an atomic `exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))` check. If a document exists at this path for the authenticated user's UID, they are an administrator. This completely removes hierarchical authorization dependencies for role-based checks, making rules robust, high-performance, and immune to issues in batched writes or transactions.\n\n**QAPs (Rules are not Filters):** This design strongly supports Query-Allowed-Paths. For the main content collections (`/documents`, `/agreementTypes`, `/projects`, `/authors`, `/keywords`), the security posture is homogeneously 'read by any authenticated user'. This means `list` operations do not require complex, resource-intensive server-side filtering within security rules. Any authenticated user can perform a `list` query on these collections, and the rules simply permit reading all documents within them, allowing client-side filtering if further restrictions are needed (e.g., by document metadata) but not for core access control. Write operations for all these collections are strictly limited to users whose UID exists in the `/roles_admin` collection.\n\n**Structural Segregation:** Each top-level collection (`/users`, `/roles_admin`, `/documents`, `/agreementTypes`, `/projects`, `/authors`, `/keywords`) is designed to contain documents that share a consistent security posture. For instance, all documents in `/documents` are universally viewable by authenticated users, simplifying the read rules for the entire collection. This avoids mixing data with different access requirements within the same collection, which would otherwise complicate security rules and potentially introduce vulnerabilities. The `User` entity also stores the `role` field as per schema, but its primary purpose is for application-level display, not rule-based authorization.\n\n**Access Modeling:** Path-based ownership is used for user profiles (`/users/{userId}`). Global roles are explicitly defined using the 'Existence over Content' pattern via `/roles_admin/{userId}`. Collaborative data patterns are not needed as documents are centrally managed by administrators and publicly viewable by all authenticated users. All wildcard parameters are semantically named (e.g., `{documentId}`, `{projectId}`) to ensure clarity and debuggability.\n\nThis structure provides a secure, scalable, and highly debuggable foundation for VínculoAgro, aligning with all specified design principles and mandates."
  }
}